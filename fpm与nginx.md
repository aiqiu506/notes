Nginx 作为一个常用的web服务端程序。它是如何工作的呢？

Nginx在启动时会**以daemon形式在后台运行**，采用**多进程+异步非阻塞IO事件模型**来处理各种连接请求。多进程模型包括一个master进程，多个worker进程，**一般worker进程个数是根据服务器CPU核数来决定的**。**master进程负责管理Nginx本身和其他worker进程**

**Master进程的作用是？**

读取并验证配置文件nginx.conf；管理worker进程；

**Worker进程的作用是？**

每一个Worker进程都维护一个线程（避免线程切换），处理连接和请求；注意Worker进程的个数由配置文件决定，一般和CPU个数相关（有利于进程切换），配置几个就有几个Worker进程。

nginx的每个worker进程都维护着一个epoll队列。即，事件驱动模型。异步响应连接的多个线程。



#### nginx的正向代理与反向代理

  正向代理，是指我们知道想要访问某个网站，由于某些原因是无法直接访问，于是通过中间机（代理器）去访问到目标网站。**清楚地知道我们最终访问了谁**。

 反向代理，是指我们我们以为我们访问的是A服务器，其它是B服务器在提供服务。B通过反向代理的方式来提供了服务。**不知道最终是谁在提供服务**。nginx通过反向代理的方式来实现负载均衡。即将多个请求分散到多台服务器来提供服务的过程。



php-fpm是一个fastcgi管理程序。。fastcgi又是什么？

先讲讲什么是cgi，cgi是一种协议，指的是web服务与其它进程之间通信的协议。

真初web服务器与php的通信是，一个请求fork一个cgi进程去执行。。这样会导致频繁地创建线程。fastcgi的出现，使得一个cgi进程可以为多个请求服务。php-fpm是fastcgi的一种。它提供php-cgi的管理。通常有一个master进程多个worker进程组成。

一个请求通过nginx的worker进程，根据匹配规则对应到所在的server块，发现里面是与一个socket的9000端口的php-fpm的cgi进程通信。于是将请求交给php-fpm处理。php-fpm拿到请求后，会分配到空闲的php-fpm的worker进程。php-fpm的worker进程内嵌一个php解析器。接下来，就是php的执行过程了。

整个php由4部分构成，php用户程序，中间的sapi,扩展层，php内核层（引擎层）。

php的执行过程为，

1、用户程序的解析（laravel框架的初始化、路由解析），找到指定的要执行的php文件。

2、通过php内核所提供的sapi接口，来调用内核或是扩展层(redis.so,math)相关的功能

3、php的内核层，也称为引擎层，会将整个php文件执行所需求的内存处理好的同时，将生成opcode,以供机器执行。



php将执行结果，反馈到用户程序。用户程序中的laravel框架，再将结果返回到php-fpm对应的worker进程，最后返回到nginx中，nginx将结果返回至客户端。