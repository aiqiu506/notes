##常见 HTTP返回状态码分析

```
|--------------------------------------------
  Author:       intro                        
  CreateAt:   2020-04-22 22:12:07        
|--------------------------------------------
  
```

#### 一、1** 正式内容响应前的消息

> 101 :switch protocols. 告诉客户端转换协议。

  这里主要介绍浏览器是如何与服务端进行 websocket 通信的。

1. 浏览器端 websocket 的连接相关的，都是写在 html 文件中的。所以，浏览器第一次进行 http 请求回 HTML 的 DOM 内容。（注：`一般浏览器不允许本地直接运行一个包含 websocket 连接的页面`）

2. 浏览器接收到 DOM内容后，执行里面包含的 js 代码。js 中含有 websocket 的连接相关代码时，浏览器发送 get 请求到对应的`地址:端口`。在`浏览器`会在 html请求的 header 中加入如下内容:

   ```html
   Connection:Upgrade
   Upgrade:websocket
   ```

   告诉服务端，本次连接需要协议升级，并且升级为 websocket。

3. 服务端接收到请求后，进行内容的response时，也需要设置 header：

   ```
   Connection: Upgrade
   Upgrade:websocket
   ```

     表示同意客户端的协议升级请求

4. 此时，浏览器与服务端的 websocket 通信，正式建立。

#### 二、2**成功

  该系统的状态码，表示服务端与客户端的请求能被处理。

> 205 Reset Content

  当服务端返回205状态码时，相当于告诉浏览器去重置表单中的内容。

#### 三、3**重定向

3**系列的状态码表示，服务器要求浏览器重定向。

> 301  Moved Permanently   永久重定向

> 302 Moved Temporarily    临时重定向

这里简单区分一下，301和302的区别。301是对搜索引擎友好的。302，相当于告诉浏览器，我可能下次就不会跳转到这个位置了。只是临时这么做。301，只要是请求这个地址，都一直重定向到指定地址。就重定向动作而言，没有区别。只是语义上的区别。毕竟协议嘛，就是一种约定。认识上统一。

> 思考：服务端是如何告诉浏览器去重定向的？

不管是301，还是302，都是服务端在 response 的 header 中，加入了`Location:url`，同时状态码设置301或302。缺一不可。直白点说，你要我跳转，那总要告诉我跳转到哪里吧。这个`哪里` 就是通过 header 带回的``Location:url``

> 304  Not Modified  没有新的修改

304这个状态的存在，是因为浏览器会在请求的时候在 header 中加上“If-Modified-Since：时间” 表示希望看一下，在指定时间之后有没有内容的变化。而服务器比对后返回304,告诉浏览器没做改变。涉及到浏览器的缓存的问题。



#### 四、4**请求错误

该类状态码表示，服务端收到请求后，代表了客户端看起来可能发生了错误，妨碍了服务器的处理。

> 400  Bad Request   错误的请求

认为请求有误（如格式、参数），同时建议浏览器不要再重复请求。

> 401 Unauthorized   未授权的访问

表示服务端对客户端的身份认证不通过。

> 403 Forbidden  没有权限访问

服务器已经理解请求，但是拒绝执行它。

注意：401与403，很大程度上，两个状态会用混。401与403，都表示服务端不同意浏览器的请求。401更侧重于`身份认证`。403更倾向于`权限认证`。



####五、5**服务器错误

服务器错误，是指服务端告诉了浏览器没有能力处理该请求。

> 500  Internal Server Error   源代码错误

> 502 Bad Gateway   错误的网关

  一般出现502状态码时，表示 web 服务器与 cgi 之间的联系出了问题。例如：nginx 没办法转发到 php-fpm 监听的9000端口时（php-fpm 宕机）。nginx 后返回浏览器一个502的状态码。

> 503 Service Unavailable  服务端过载

> 504 Gateway Timeout  网关超时

  nginx 和 php-fpm 都有最大响应时长。nginx默认为60秒，php-fpm 默认为30秒。浏览器最大响应时长为2分钟。

浏览器从发起一个请求到接到响应的总时长。如果30秒，php-fpm没有响应 nginx，php-fpm会触发超时，nginx会等到60秒再返回504状态码到浏览器。

#### 六、问题

502状态如何分析：

502状态一出现，一定是 web 服务器与 fast_cgi 出了问题。

1.FastCGI进程是否已经启动
2.FastCGI worker进程数是否不够

运行` netstat -anpo | grep “php-cgi” | wc -l` 判断是否接近FastCGI进程，接近配置文件中设置的数值，表明worker进程数设置太少。

